<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æƒ…ç·’èª¿è§£å“¡</title>

<style>
    /* å­—é«”è¨­å®š */
    @font-face {
        font-family: 'Iansui';
        src: url('Iansui.ttf') format('truetype');
        font-display: swap;
    }

    /* å…¨åŸŸè¨­å®š */
    body {
        font-family: 'Iansui', 'Heiti TC', sans-serif;
        background-color: #FBF9F1; 
        color: #5D4037; 
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        height: 100vh;
        overflow: hidden;
        user-select: none;
    }

    #app-container {
        width: 100%;
        max-width: 480px;
        background-color: #FBF9F1;
        position: relative;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    /* é é¢åˆ‡æ› */
    .screen {
        display: none;
        width: 100%;
        height: 100%;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start; /* æ”¹ç‚ºå¾ä¸Šæ–¹é–‹å§‹æ’ */
        padding-top: 60px; /* ä¸Šæ–¹ç•™ç™½ */
        position: absolute;
        top: 0;
        left: 0;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        padding: 20px;
        box-sizing: border-box;
        background-color: #FBF9F1;
        z-index: 1;
        overflow-y: auto; /* å…è¨±å‚ç›´æ²å‹• (ç‚ºäº†ç´€éŒ„åˆ—è¡¨) */
    }

    /* ç½®ä¸­å…§å®¹å°ˆç”¨ (é¦–é ã€æ·±å‘¼å¸ã€çµæœé ) */
    .center-content {
        justify-content: center; 
        padding-top: 0;
    }

    .active {
        display: flex !important;
        opacity: 1;
        z-index: 10;
    }

    /* æ–‡å­—èˆ‡æŒ‰éˆ• */
    h2 { font-size: 1.8rem; margin-bottom: 20px; color: #5D4037; text-align: center; }
    p { font-size: 1.2rem; color: #795548; text-align: center; margin-top: 10px; }
    
    .btn {
        border: none;
        border-radius: 50px;
        padding: 15px 30px;
        font-size: 1.1rem;
        cursor: pointer;
        margin-top: 15px;
        font-family: inherit;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
    }
    .btn:active { transform: translateY(4px); box-shadow: none; }
    .btn-primary { background-color: #8D6E63; color: white; }
    .btn-outline { background-color: transparent; border: 2px solid #8D6E63; color: #8D6E63; }
    .btn-text { background: none; border: none; color: #8D6E63; font-size: 1rem; text-decoration: underline; box-shadow: none; }

    /* ç´…ç¶ ç‡ˆ */
    .traffic-light-container {
        display: flex; 
        flex-direction: column; 
        gap: 20px; width: 100%; max-width: 350px;
    }
    .light-btn-group {
        display: flex; align-items: center; gap: 20px; cursor: pointer;
        background: white; padding: 15px 25px; border-radius: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    }
    .traffic-light { width: 50px; height: 50px; border-radius: 50%; flex-shrink: 0; }
    .bg-red { background-color: #FFAB91; }
    .bg-yellow { background-color: #FFF59D; }
    .bg-green { background-color: #A5D6A7; }
    .text-group { text-align: left; }
    .text-group h3 { margin: 0; font-size: 1.3rem; }
    .text-group span { font-size: 0.95rem; color: #9E9E9E; }

    /* æ·±å‘¼å¸ */
    .breath-circle-outer { width: 260px; height: 260px; background: rgba(178, 235, 242, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .breath-circle { width: 120px; height: 120px; background: #80DEEA; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.8rem; }
    .breathing { animation: breathAnim 8s infinite ease-in-out; }
    @keyframes breathAnim {
        0% { transform: scale(1); } 40% { transform: scale(2.0); } 50% { transform: scale(2.0); } 90% { transform: scale(1); } 100% { transform: scale(1); }
    }

    /* æ¨¹æ´è¼¸å…¥æ¡† */
    textarea {
        width: 100%; height: 200px; border-radius: 20px; border: none; padding: 20px;
        font-size: 1.2rem; background: #FFF; resize: none; margin-bottom: 20px;
        font-family: inherit; box-sizing: border-box;
    }

    /* ç´€éŒ„åˆ—è¡¨æ¨£å¼ */
    .history-list {
        width: 100%;
        max-width: 400px;
        margin-top: 10px;
    }
    .history-card {
        background: white;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border-left: 8px solid #ddd; /* é è¨­é¡è‰² */
    }
    .card-red { border-left-color: #FFAB91; }
    .card-yellow { border-left-color: #FFF59D; }
    .card-green { border-left-color: #A5D6A7; }
    
    .history-time { font-size: 0.85rem; color: #999; margin-bottom: 5px; }
    .history-mood { font-weight: bold; color: #5D4037; margin-bottom: 5px; font-size: 1.1rem;}
    .history-text { font-size: 1rem; color: #666; white-space: pre-wrap; }

    /* è¼‰å…¥ä¸­å‹•ç•« */
    .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #8D6E63;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

</style>
</head>
<body>

<div id="app-container">

    <!-- 1. é¦–é  -->
    <div id="screen-home" class="screen center-content active">
        <h2 style="font-size: 2.2rem; font-weight: bold;">æƒ…ç·’èª¿è§£å“¡</h2>
        <p style="margin-bottom: 30px;">å˜¿ï¼ç¾åœ¨çš„æ„Ÿè¦ºåƒä»€éº¼é¡è‰²ï¼Ÿ</p>

        <div class="traffic-light-container">
            <div class="light-btn-group" onclick="selectMood('ç´…ç‡ˆ', '#screen-breath')">
                <div class="traffic-light bg-red"></div>
                <div class="text-group"><h3>å¿«è¦çˆ†ç‚¸äº†</h3><span>ç”Ÿæ°£ã€é›£é</span></div>
            </div>
            <div class="light-btn-group" onclick="selectMood('é»ƒç‡ˆ', '#screen-breath')">
                <div class="traffic-light bg-yellow"></div>
                <div class="text-group"><h3>æœ‰ä¸€é»é»ç…©</h3><span>ç„¦æ…®ã€æ··äº‚</span></div>
            </div>
            <div class="light-btn-group" onclick="selectMood('ç¶ ç‡ˆ', '#screen-record')">
                <div class="traffic-light bg-green"></div>
                <div class="text-group"><h3>æ„Ÿè¦ºå¾ˆä¸éŒ¯</h3><span>å¹³éœã€é–‹å¿ƒ</span></div>
            </div>
        </div>
        
        <!-- æ–°å¢ï¼šæŸ¥çœ‹ç´€éŒ„æŒ‰éˆ• -->
        <button class="btn btn-text" style="margin-top: 40px;" onclick="loadHistory()">ğŸ“– æŸ¥çœ‹å¿ƒæƒ…æ—¥è¨˜</button>
    </div>

    <!-- 2. é™æº«å€ -->
    <div id="screen-breath" class="screen center-content">
        <h2 style="margin-bottom: 50px;">è·Ÿéš¨åœ“åœˆæ·±å‘¼å¸</h2>
        <div class="breath-circle-outer"><div id="breath-ball" class="breath-circle">å¸æ°£</div></div>
        <p id="breath-text" style="font-size: 1.5rem; margin-top: 40px; color: #0097A7;">æ…¢æ…¢å¸æ°£...</p>
        <div style="flex-grow: 1;"></div>
        <button class="btn btn-primary" style="background-color: #0097A7; margin-bottom: 40px;" onclick="stopBreath(); navigate('#screen-record')">å¿ƒæƒ…å¹³éœäº†</button>
    </div>

    <!-- 3. è¡¨é”å€ -->
    <div id="screen-record" class="screen center-content">
        <h2>å¿ƒæƒ…æ¨¹æ´</h2>
        <p style="margin-bottom: 20px;">å¯«ä¸‹ä½ çš„æƒ³æ³•ï¼Œæˆ‘æœƒå¹«ä½ å­˜åˆ°é›²ç«¯ï¼š</p>
        <textarea id="mood-input" placeholder="å‰›å‰›ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿæˆ‘çš„æ„Ÿè¦ºæ˜¯..."></textarea>
        <div style="display: flex; gap: 15px;">
            <button class="btn btn-outline" onclick="navigate('#screen-home')">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="save-btn" onclick="saveMoodToCloud()">è¨˜éŒ„ä¸‹ä¾†</button>
        </div>
        <div id="save-loader" class="loader"></div> <!-- å„²å­˜ä¸­çš„è½‰åœˆåœˆ -->
    </div>

    <!-- 4. çµå°¾ -->
    <div id="screen-finish" class="screen center-content">
        <div style="font-size: 6rem;">ğŸ…</div>
        <h2 style="margin-top: 10px;">å„²å­˜æˆåŠŸï¼</h2>
        <p>ä½ çš„å¿ƒæƒ…å·²ç¶“è¢«å¦¥å–„ä¿ç®¡äº†ã€‚</p>
        <br><br>
        <button class="btn btn-primary" onclick="navigate('#screen-home')">å›åˆ°é¦–é </button>
    </div>

    <!-- 5. æ–°å¢ï¼šæ­·å²ç´€éŒ„é  -->
    <div id="screen-history" class="screen">
        <h2>å¿ƒæƒ…æ—¥è¨˜æœ¬</h2>
        <div id="history-loader" class="loader" style="display: block;"></div>
        <div id="history-container" class="history-list">
            <!-- é€™è£¡æœƒç”±ç¨‹å¼è‡ªå‹•å¡«å…¥ç´€éŒ„ -->
        </div>
        <button class="btn btn-outline" style="margin-bottom: 30px;" onclick="navigate('#screen-home')">é—œé–‰æ—¥è¨˜</button>
    </div>

</div>

<script>
    // ==========================================
    // âš ï¸ è«‹åœ¨é€™è£¡è²¼ä¸Šä½ çš„ Apps Script ç¶²å€ âš ï¸
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzGkt3Z18apZUZZKIm-7hlqu5NXg1hj8Cf-mwo5HYjSXWnv7pN9k3Ei76RB7uJhQa731Q/exec";
    // ==========================================

    let currentMood = "";
    let breathInterval;

    // é é¢åˆ‡æ›
    function navigate(screenId) {
        document.querySelectorAll('.screen').forEach(el => {
            el.style.display = 'none';
            el.classList.remove('active');
        });
        const nextScreen = document.querySelector(screenId);
        if (nextScreen) {
            nextScreen.style.display = 'flex';
            setTimeout(() => nextScreen.classList.add('active'), 50);
        }
    }

    function selectMood(mood, nextScreen) {
        currentMood = mood;
        navigate(nextScreen);
        if(nextScreen === '#screen-breath') setTimeout(startBreath, 100);
    }

    // æ·±å‘¼å¸é‚è¼¯ (ç¶­æŒä¸è®Š)
    function startBreath() {
        const ball = document.getElementById('breath-ball');
        const text = document.getElementById('breath-text');
        stopBreath();
        ball.classList.add('breathing');
        text.innerText = "æ…¢æ…¢å¸æ°£...";
        ball.innerText = "å¸";
        const runCycle = () => {
            setTimeout(() => { if(document.querySelector('#screen-breath').style.display !== 'none'){ text.innerText = "ä¿æŒ..."; ball.innerText = "åœ"; } }, 3200);
            setTimeout(() => { if(document.querySelector('#screen-breath').style.display !== 'none'){ text.innerText = "æ…¢æ…¢åæ°£..."; ball.innerText = "å"; } }, 4000);
            setTimeout(() => { if(document.querySelector('#screen-breath').style.display !== 'none'){ text.innerText = "æ…¢æ…¢å¸æ°£..."; ball.innerText = "å¸"; } }, 8000);
        };
        runCycle(); 
        breathInterval = setInterval(runCycle, 8000);
    }
    function stopBreath() {
        document.getElementById('breath-ball').classList.remove('breathing');
        if (breathInterval) clearInterval(breathInterval);
    }

    // --- é›²ç«¯åŠŸèƒ½é–‹å§‹ ---

    // 1. å„²å­˜åˆ° Google Sheets
    function saveMoodToCloud() {
        let input = document.getElementById('mood-input');
        let text = input.value;
        if(text.trim() === "") text = "(æ²’æœ‰æ–‡å­—è¨˜éŒ„)";

        // é¡¯ç¤ºè®€å–å‹•ç•«ï¼Œç¦ç”¨æŒ‰éˆ•
        document.getElementById('save-loader').style.display = 'block';
        document.getElementById('save-btn').disabled = true;
        document.getElementById('save-btn').innerText = "å„²å­˜ä¸­...";

        // æº–å‚™å‚³é€çš„è³‡æ–™
        const data = {
            mood: currentMood,
            text: text
        };

        // ä½¿ç”¨ fetch ç™¼é€ (no-cors æ¨¡å¼)
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // é‡è¦ï¼šå…è¨±è·¨åŸŸå‚³é€
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(() => {
            // å› ç‚ºæ˜¯ no-corsï¼Œæˆ‘å€‘å‡è¨­ç™¼é€å‡ºå»å°±æˆåŠŸäº†
            document.getElementById('save-loader').style.display = 'none';
            document.getElementById('save-btn').disabled = false;
            document.getElementById('save-btn').innerText = "è¨˜éŒ„ä¸‹ä¾†";
            input.value = "";
            navigate('#screen-finish');
        }).catch(err => {
            alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
            console.error(err);
            document.getElementById('save-loader').style.display = 'none';
            document.getElementById('save-btn').disabled = false;
        });
    }

    // 2. è®€å–æ­·å²ç´€éŒ„
    function loadHistory() {
        navigate('#screen-history');
        const container = document.getElementById('history-container');
        const loader = document.getElementById('history-loader');
        
        container.innerHTML = ""; // æ¸…ç©ºèˆŠçš„
        loader.style.display = 'block';

        fetch(GOOGLE_SCRIPT_URL)
        .then(response => response.json())
        .then(data => {
            loader.style.display = 'none';
            
            // è³‡æ–™åè½‰ï¼Œè®“æœ€æ–°çš„é¡¯ç¤ºåœ¨æœ€ä¸Šé¢
            data.reverse();

            if (data.length === 0) {
                container.innerHTML = "<p>ç›®å‰é‚„æ²’æœ‰ç´€éŒ„å–”ï¼</p>";
                return;
            }

            data.forEach(row => {
                // row[0]=æ™‚é–“, row[1]=å¿ƒæƒ…, row[2]=å…§å®¹
                // è™•ç†æ™‚é–“é¡¯ç¤º
                let date = new Date(row[0]);
                let timeStr = date.toLocaleString('zh-TW', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' });
                
                // æ±ºå®šå¡ç‰‡é¡è‰²
                let cardClass = "";
                if(row[1] === "ç´…ç‡ˆ") cardClass = "card-red";
                else if(row[1] === "é»ƒç‡ˆ") cardClass = "card-yellow";
                else cardClass = "card-green";

                // å»ºç«‹å¡ç‰‡ HTML
                const card = document.createElement('div');
                card.className = `history-card ${cardClass}`;
                card.innerHTML = `
                    <div class="history-time">${timeStr}</div>
                    <div class="history-mood">${row[1]}</div>
                    <div class="history-text">${row[2]}</div>
                `;
                container.appendChild(card);
            });
        })
        .catch(err => {
            loader.style.display = 'none';
            container.innerHTML = "<p>ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¶²å€è¨­å®šã€‚</p>";
            console.error(err);
        });
    }

</script>

</body>
</html>