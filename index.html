<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æƒ…ç·’èª¿è§£å“¡</title>

<style>
    /* å­—é«”è¨­å®š */
    @font-face {
        font-family: 'Iansui';
        src: url('Iansui.ttf') format('truetype');
        font-display: swap;
    }

    /* å…¨åŸŸè¨­å®š */
    body {
        font-family: 'Iansui', 'Heiti TC', sans-serif;
        background-color: #FBF9F1; 
        color: #5D4037; 
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        height: 100vh;
        overflow: hidden;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    #app-container {
        width: 100%;
        max-width: 480px;
        background-color: #FBF9F1;
        position: relative;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow-y: auto; 
    }

    /* é é¢åˆ‡æ› */
    .screen {
        display: none;
        width: 100%;
        min-height: 100%;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 50px;
        padding-bottom: 50px;
        transition: opacity 0.3s ease-in-out;
        opacity: 0;
        box-sizing: border-box;
        background-color: #FBF9F1;
    }
    
    .center-content { justify-content: center; padding-top: 0; }
    .active { display: flex !important; opacity: 1; z-index: 10; }

    /* é€šç”¨æ–‡å­— */
    h2 { font-size: 1.8rem; margin-bottom: 20px; color: #5D4037; text-align: center; }
    p { font-size: 1.1rem; color: #795548; text-align: center; margin-top: 5px; padding: 0 20px; }
    
    /* æŒ‰éˆ• */
    .btn {
        border: none; border-radius: 50px; padding: 12px 30px;
        font-size: 1.1rem; cursor: pointer; margin-top: 15px;
        font-family: inherit; box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.1s;
    }
    .btn:active { transform: translateY(3px); box-shadow: none; }
    .btn-primary { background-color: #8D6E63; color: white; }
    .btn-outline { background-color: transparent; border: 2px solid #8D6E63; color: #8D6E63; }
    
    /* é¦–é æŒ‰éˆ•ç¾¤çµ„ */
    .home-actions {
        display: flex;
        gap: 10px;
        margin-top: 30px;
    }

    /* ç´…ç¶ ç‡ˆ */
    .traffic-light-container { display: flex; flex-direction: column; gap: 15px; width: 90%; max-width: 350px; margin-top: 20px; }
    .light-btn-group { display: flex; align-items: center; gap: 20px; cursor: pointer; background: white; padding: 15px 25px; border-radius: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .traffic-light { width: 50px; height: 50px; border-radius: 50%; flex-shrink: 0; }
    .bg-red { background-color: #FFAB91; } .bg-yellow { background-color: #FFF59D; } .bg-green { background-color: #A5D6A7; }
    .text-group { text-align: left; } .text-group h3 { margin: 0; font-size: 1.2rem; } .text-group span { font-size: 0.9rem; color: #999; }

    /* æ·±å‘¼å¸ */
    .breath-circle-outer { width: 240px; height: 240px; background: rgba(178, 235, 242, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-top: 20px; }
    .breath-circle { width: 110px; height: 110px; background: #80DEEA; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; }
    .breathing { animation: breathAnim 8s infinite ease-in-out; }
    @keyframes breathAnim { 0% {transform: scale(1);} 40% {transform: scale(2.0);} 50% {transform: scale(2.0);} 90% {transform: scale(1);} 100% {transform: scale(1);} }

    /* è¡¨é”å€ */
    .tab-container { display: flex; gap: 10px; margin-bottom: 15px; }
    .tab-btn { padding: 8px 20px; border-radius: 20px; border: 1px solid #8D6E63; background: transparent; color: #8D6E63; cursor: pointer; }
    .tab-btn.active-tab { background: #8D6E63; color: white; }
    .input-area { width: 90%; display: none; flex-direction: column; align-items: center; }
    .input-area.show { display: flex; }
    .mic-btn { width: 60px; height: 60px; border-radius: 50%; background: #FFCC80; border: none; font-size: 1.5rem; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; margin: 10px 0; display: flex; align-items: center; justify-content: center; }
    .mic-listening { animation: pulse 1.5s infinite; background: #FF7043; }
    @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255, 112, 67, 0.7);} 70% {box-shadow: 0 0 0 15px rgba(255, 112, 67, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 112, 67, 0);} }
    textarea { width: 100%; height: 150px; border-radius: 20px; border: 2px solid #E0E0E0; padding: 15px; font-size: 1.1rem; resize: none; font-family: inherit; box-sizing: border-box; }
    canvas { background: white; border-radius: 20px; border: 2px solid #E0E0E0; touch-action: none; cursor: crosshair; }
    .color-picker { display: flex; gap: 10px; margin-top: 10px; }
    .color-dot { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; }
    
    /* æ€¥æ•‘åŒ… */
    .kit-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 95%; margin-top: 30px; }
    .kit-card { background: white; border-radius: 15px; padding: 15px 5px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s; text-align: center; height: 110px; justify-content: center; }
    .kit-card:active { transform: scale(0.95); }
    .kit-icon { font-size: 2.5rem; margin-bottom: 10px; }
    .kit-label { font-size: 0.9rem; color: #5D4037; font-weight: bold; }
    #stress-ball { width: 150px; height: 150px; background: radial-gradient(circle at 30% 30%, #FFAB91, #FF7043); border-radius: 50%; box-shadow: 0 10px 20px rgba(0,0,0,0.2); margin: 30px auto; transition: transform 0.1s; cursor: pointer; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.8); font-size: 1.2rem; }

    /* æ­·å²ç´€éŒ„èˆ‡æœˆæ›† */
    .history-list { width: 90%; max-width: 400px; margin-top: 10px; padding-bottom: 50px; }
    .history-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 8px solid #ddd; position: relative; }
    .card-red { border-left-color: #FFAB91; } .card-yellow { border-left-color: #FFF59D; } .card-green { border-left-color: #A5D6A7; }
    .history-time { font-size: 0.85rem; color: #999; } .history-mood { font-weight: bold; font-size: 1.1rem; margin: 5px 0; } .history-text { color: #666; white-space: pre-wrap; }
    .delete-btn { position: absolute; right: 15px; top: 15px; background: none; border: 1px solid #FF8A80; color: #FF8A80; border-radius: 15px; padding: 2px 10px; font-size: 0.8rem; cursor: pointer; }

    /* === æœˆæ›†å°ˆç”¨æ¨£å¼ === */
    .calendar-container { width: 90%; max-width: 400px; background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .cal-header h3 { margin: 0; color: #5D4037; }
    .cal-nav { background: #8D6E63; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }
    
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
    .cal-day-name { font-size: 0.9rem; color: #999; padding-bottom: 10px; }
    .cal-day { height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 5px; border-radius: 10px; font-size: 0.9rem; color: #555; position: relative; }
    .cal-dots { display: flex; gap: 3px; margin-top: 3px; flex-wrap: wrap; justify-content: center; }
    .dot { width: 6px; height: 6px; border-radius: 50%; }
    .dot-r { background: #FFAB91; } .dot-y { background: #FFF59D; } .dot-g { background: #A5D6A7; }
    
    .cal-stats { display: flex; justify-content: space-around; width: 100%; margin-top: 20px; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .stat-item { text-align: center; }
    .stat-num { font-size: 1.5rem; font-weight: bold; display: block; }
    
    /* è¼‰å…¥å‹•ç•« */
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #8D6E63; border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
    @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

</style>
</head>
<body>

<!-- éš±è—çš„éŸ³æ•ˆæª” -->
<audio id="bg-music" loop>
    <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=relaxing-mountains-141205.mp3" type="audio/mpeg">
</audio>

<div id="app-container">

    <!-- 1. é¦–é  -->
    <div id="screen-home" class="screen center-content active">
        <h2 style="font-size: 2.2rem; font-weight: bold;">æƒ…ç·’èª¿è§£å“¡</h2>
        <p style="margin-bottom: 30px;">å˜¿ï¼ç¾åœ¨çš„æ„Ÿè¦ºåƒä»€éº¼é¡è‰²ï¼Ÿ</p>

        <div class="traffic-light-container">
            <div class="light-btn-group" onclick="selectMood('ç´…ç‡ˆ', '#screen-breath')">
                <div class="traffic-light bg-red"></div>
                <div class="text-group"><h3>å¿«è¦çˆ†ç‚¸äº†</h3><span>ç”Ÿæ°£ã€é›£é</span></div>
            </div>
            <div class="light-btn-group" onclick="selectMood('é»ƒç‡ˆ', '#screen-breath')">
                <div class="traffic-light bg-yellow"></div>
                <div class="text-group"><h3>æœ‰ä¸€é»é»ç…©</h3><span>ç„¦æ…®ã€æ··äº‚</span></div>
            </div>
            <div class="light-btn-group" onclick="selectMood('ç¶ ç‡ˆ', '#screen-express')">
                <div class="traffic-light bg-green"></div>
                <div class="text-group"><h3>æ„Ÿè¦ºå¾ˆä¸éŒ¯</h3><span>å¹³éœã€é–‹å¿ƒ</span></div>
            </div>
        </div>
        
        <div class="home-actions">
            <button class="btn btn-outline" style="border:1px solid #8D6E63; padding: 10px 15px; font-size: 1rem;" onclick="loadHistory()">ğŸ“– å¿ƒæƒ…æ—¥è¨˜</button>
            <button class="btn btn-outline" style="border:1px solid #8D6E63; padding: 10px 15px; font-size: 1rem;" onclick="loadCalendar()">ğŸ“… å¿ƒæƒ…æœˆæ›†</button>
        </div>
    </div>

    <!-- 2. é™æº«å€ -->
    <div id="screen-breath" class="screen center-content">
        <h2>è·Ÿéš¨åœ“åœˆæ·±å‘¼å¸</h2>
        <div class="breath-circle-outer"><div id="breath-ball" class="breath-circle">å¸æ°£</div></div>
        <p id="breath-text" style="font-size: 1.5rem; margin-top: 40px; color: #0097A7;">æ…¢æ…¢å¸æ°£...</p>
        <div style="flex-grow: 1;"></div>
        <button class="btn btn-primary" style="background-color: #0097A7; margin-bottom: 40px;" onclick="stopBreath(); navigate('#screen-express')">å¿ƒæƒ…å¹³éœäº†</button>
    </div>

    <!-- 3. è¡¨é”å€ -->
    <div id="screen-express" class="screen center-content">
        <h2>å¿ƒæƒ…æ¨¹æ´</h2>
        <p>é¸æ“‡ä½ å–œæ­¡çš„æ–¹å¼è¨˜éŒ„å¿ƒæƒ…ï¼š</p>
        <div class="tab-container">
            <button class="tab-btn active-tab" onclick="switchTab('write')">å¯«å­—/éŒ„éŸ³</button>
            <button class="tab-btn" onclick="switchTab('draw')">å¡—é´‰ç•«ç•«</button>
        </div>
        <div id="area-write" class="input-area show">
            <textarea id="mood-input" placeholder="ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿé»æ“Šä¸‹æ–¹éº¥å…‹é¢¨ä¹Ÿå¯ä»¥ç”¨èªªçš„å–”..."></textarea>
            <button id="mic-btn" class="mic-btn" onclick="toggleRecording()">ğŸ¤</button>
            <p id="mic-status" style="font-size:0.9rem; color:#999;">é»æ“ŠéŒ„éŸ³</p>
        </div>
        <div id="area-draw" class="input-area">
            <canvas id="draw-canvas" width="300" height="300"></canvas>
            <div class="color-picker">
                <div class="color-dot" style="background:#5D4037;" onclick="setColor('#5D4037')"></div>
                <div class="color-dot" style="background:#FFAB91;" onclick="setColor('#FFAB91')"></div>
                <div class="color-dot" style="background:#80DEEA;" onclick="setColor('#80DEEA')"></div>
                <div class="color-dot" style="background:#FFF59D;" onclick="setColor('#FFF59D')"></div>
                <button class="btn-outline" style="padding: 2px 10px; font-size:0.8rem; margin:0;" onclick="clearCanvas()">æ¸…é™¤</button>
            </div>
        </div>
        <div style="display: flex; gap: 15px; margin-top:20px;">
            <button class="btn btn-primary" id="save-btn" onclick="saveMoodToCloud()">è¨˜éŒ„ä¸¦ç¹¼çºŒ</button>
        </div>
        <div id="save-loader" class="loader"></div>
    </div>

    <!-- 4. è¡Œå‹•å€ -->
    <div id="screen-action" class="screen center-content">
        <h2>æƒ…ç·’æ€¥æ•‘åŒ…</h2>
        <p>é¸ä¸€å€‹è®“è‡ªå·±æ›´é–‹å¿ƒçš„æ–¹æ³•ï¼š</p>
        <div class="kit-grid">
            <div class="kit-card" onclick="toggleMusic(this)"><div class="kit-icon">ğŸ§</div><div class="kit-label">è½è¼•éŸ³æ¨‚</div></div>
            <div class="kit-card" onclick="openStressBall()"><div class="kit-icon">ğŸ”´</div><div class="kit-label">ææèˆ’å£“çƒ</div></div>
            <div class="kit-card" onclick="showJoke()"><div class="kit-icon">ğŸ’¡</div><div class="kit-label">çœ‹å†·çŸ¥è­˜</div></div>
        </div>
        <div style="flex-grow: 1;"></div>
        <button class="btn btn-outline" onclick="navigate('#screen-finish')">æˆ‘æº–å‚™å¥½äº†</button>
        <br><br>
    </div>

    <!-- 4.1 èˆ’å£“çƒ -->
    <div id="screen-ball" class="screen center-content" style="background-color: #FFF3E0;">
        <h2>ç›¡æƒ…é‡‹æ”¾å£“åŠ›</h2>
        <div id="stress-ball" onmousedown="squeezeBall()" ontouchstart="squeezeBall()" onmouseup="releaseBall()" ontouchend="releaseBall()">ææˆ‘</div>
        <div style="flex-grow: 1;"></div>
        <button class="btn btn-outline" onclick="navigate('#screen-action')">å›åˆ°æ€¥æ•‘åŒ…</button>
        <br><br>
    </div>

    <!-- 5. çµå°¾ -->
    <div id="screen-finish" class="screen center-content">
        <div style="font-size: 6rem;">ğŸ…</div>
        <h2>å®Œæˆï¼</h2>
        <p>ä½ å¾ˆæ£’ï¼Œè¬è¬ä½ ç…§é¡§äº†è‡ªå·±çš„æƒ…ç·’ã€‚</p>
        <br><br>
        <button class="btn btn-primary" onclick="stopMusic(); navigate('#screen-home')">å›åˆ°é¦–é </button>
    </div>

    <!-- 6. æ­·å²ç´€éŒ„ -->
    <div id="screen-history" class="screen">
        <h2>æ—¥è¨˜æœ¬</h2>
        <div id="history-loader" class="loader"></div>
        <div id="history-container" class="history-list"></div>
        <button class="btn btn-outline" style="margin-bottom: 30px;" onclick="navigate('#screen-home')">é—œé–‰</button>
    </div>

    <!-- 7. å¿ƒæƒ…æœˆæ›† (æ–°å¢) -->
    <div id="screen-calendar" class="screen">
        <h2>å¿ƒæƒ…æœˆæ›†</h2>
        <div id="cal-loader" class="loader"></div>
        
        <div class="calendar-container">
            <div class="cal-header">
                <button class="cal-nav" onclick="changeMonth(-1)">&#8249;</button>
                <h3 id="cal-month-title">2026å¹´ 1æœˆ</h3>
                <button class="cal-nav" onclick="changeMonth(1)">&#8250;</button>
            </div>
            
            <div class="cal-grid">
                <div class="cal-day-name">æ—¥</div>
                <div class="cal-day-name">ä¸€</div>
                <div class="cal-day-name">äºŒ</div>
                <div class="cal-day-name">ä¸‰</div>
                <div class="cal-day-name">å››</div>
                <div class="cal-day-name">äº”</div>
                <div class="cal-day-name">å…­</div>
                <!-- æ—¥æœŸæœƒç”± JS å‹•æ…‹å¡«å…¥ -->
            </div>
            <div id="cal-days" class="cal-grid"></div>
        </div>

        <!-- çµ±è¨ˆå€ -->
        <div class="cal-stats">
            <div class="stat-item">
                <span class="stat-num" style="color:#FFAB91" id="stat-red">0</span>
                <span style="font-size:0.8rem">ç´…ç‡ˆ</span>
            </div>
            <div class="stat-item">
                <span class="stat-num" style="color:#FBC02D" id="stat-yellow">0</span>
                <span style="font-size:0.8rem">é»ƒç‡ˆ</span>
            </div>
            <div class="stat-item">
                <span class="stat-num" style="color:#81C784" id="stat-green">0</span>
                <span style="font-size:0.8rem">ç¶ ç‡ˆ</span>
            </div>
        </div>

        <div style="flex-grow: 1;"></div>
        <button class="btn btn-outline" style="margin-bottom: 30px;" onclick="navigate('#screen-home')">é—œé–‰</button>
    </div>

</div>

<script>
    // ==========================================
    // âš ï¸ è«‹å¡«å…¥ä½ çš„ Google Script ç¶²å€ âš ï¸
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzjUpIzVX5Y0TrvmI-WvzIklA381qu9q0w3r5CUfVzhLG-WUYrhrhzzd0j1yOGor-77Jw/exec";
    // ==========================================

    let currentMood = "";
    let breathInterval;
    let recognition;
    let isRecording = false;
    let isMusicPlaying = false;
    let hasDrawn = false; 

    // æœˆæ›†è®Šæ•¸
    let currentCalDate = new Date(); // ç•¶å‰æŸ¥çœ‹çš„æœˆä»½
    let cachedData = []; // å¿«å–ä¸‹è¼‰çš„è³‡æ–™ï¼Œé¿å…åˆ‡æ›æœˆä»½æ™‚é‡è¤‡ä¸‹è¼‰

    // é é¢åˆ‡æ›
    function navigate(screenId) {
        document.querySelectorAll('.screen').forEach(el => {
            el.style.display = 'none';
            el.classList.remove('active');
        });
        const nextScreen = document.querySelector(screenId);
        if (nextScreen) {
            nextScreen.style.display = 'flex';
            setTimeout(() => nextScreen.classList.add('active'), 50);
        }
    }

    function selectMood(mood, nextScreen) {
        currentMood = mood;
        navigate(nextScreen);
        if(nextScreen === '#screen-breath') setTimeout(startBreath, 100);
    }

    // Tab åˆ‡æ›
    function switchTab(type) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
        document.querySelectorAll('.input-area').forEach(a => a.classList.remove('show'));
        if(type === 'write') {
            document.querySelectorAll('.tab-btn')[0].classList.add('active-tab');
            document.getElementById('area-write').classList.add('show');
        } else {
            document.querySelectorAll('.tab-btn')[1].classList.add('active-tab');
            document.getElementById('area-draw').classList.add('show');
            initCanvas();
        }
    }

    // èªéŸ³è¾¨è­˜
    function toggleRecording() {
        if (!('webkitSpeechRecognition' in window)) { alert("è«‹ä½¿ç”¨ Chrome ç€è¦½å™¨"); return; }
        if (isRecording) { recognition.stop(); return; }
        recognition = new webkitSpeechRecognition();
        recognition.lang = "zh-TW";
        recognition.continuous = false;
        recognition.onstart = function() { isRecording = true; document.getElementById('mic-btn').classList.add('mic-listening'); document.getElementById('mic-status').innerText = "è†è½ä¸­..."; };
        recognition.onend = function() { isRecording = false; document.getElementById('mic-btn').classList.remove('mic-listening'); document.getElementById('mic-status').innerText = "é»æ“ŠéŒ„éŸ³"; };
        recognition.onresult = function(event) {
            const t = event.results[0][0].transcript;
            const ta = document.getElementById('mood-input');
            ta.value += (ta.value ? "\n" : "") + t;
        };
        recognition.start();
    }

    // å¡—é´‰æ¿
    let canvas, ctx, isDrawing = false;
    function initCanvas() {
        canvas = document.getElementById('draw-canvas');
        ctx = canvas.getContext('2d');
        ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = 5; ctx.strokeStyle = '#5D4037';
        if(!hasDrawn) { ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height); }
        canvas.addEventListener('touchstart', startDraw, {passive: false}); canvas.addEventListener('touchmove', draw, {passive: false}); canvas.addEventListener('touchend', stopDraw);
        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stopDraw);
    }
    function getPos(e) { const r = canvas.getBoundingClientRect(); if(e.touches) return { x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top }; return { x: e.clientX - r.left, y: e.clientY - r.top }; }
    function startDraw(e) { e.preventDefault(); isDrawing = true; hasDrawn = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); }
    function draw(e) { if(!isDrawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); }
    function stopDraw() { isDrawing = false; }
    function setColor(c) { ctx.strokeStyle = c; }
    function clearCanvas() { ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height); hasDrawn = false; }

    // è¡Œå‹•å€
    function toggleMusic(card) {
        const audio = document.getElementById('bg-music');
        const label = card.querySelector('.kit-label');
        if(isMusicPlaying) { audio.pause(); isMusicPlaying = false; card.style.background = "white"; label.innerText = "è½è¼•éŸ³æ¨‚"; }
        else { audio.play().catch(e=>alert("è«‹äº’å‹•")); isMusicPlaying = true; card.style.background = "#E0F2F1"; label.innerText = "æ’­æ”¾ä¸­..."; }
    }
    function stopMusic() { const audio = document.getElementById('bg-music'); audio.pause(); audio.currentTime = 0; isMusicPlaying = false; }
    function openStressBall() { navigate('#screen-ball'); }
    function squeezeBall() { document.getElementById('stress-ball').style.transform = "scale(0.8)"; if(navigator.vibrate) navigator.vibrate(50); }
    function releaseBall() { document.getElementById('stress-ball').style.transform = "scale(1)"; }
    function showJoke() { const j = ["ä½ çŸ¥é“æµ·è±šç‚ºä»€éº¼æœƒè·³å‡ºæ°´é¢å—ï¼Ÿ\nå› ç‚ºç‰ å€‘æƒ³çœ‹æµ·é·—ï¼", "å¿ƒç†å­¸å°çŸ¥è­˜ï¼šæ·±å‘¼å¸ 3 æ¬¡å¯ä»¥æœ‰æ•ˆé™ä½ 40% çš„ç„¦æ…®æ„Ÿå–”ï¼", "ç‚ºä»€éº¼é›»è…¦å¾ˆå†·ï¼Ÿ\nå› ç‚ºå®ƒæœ‰ Windows"]; alert(j[Math.floor(Math.random()*j.length)]); }

    // æ·±å‘¼å¸
    function startBreath() {
        const ball = document.getElementById('breath-ball'); const text = document.getElementById('breath-text');
        stopBreath(); ball.classList.add('breathing'); text.innerText = "æ…¢æ…¢å¸æ°£..."; ball.innerText = "å¸";
        const run = () => {
            setTimeout(() => { if(document.querySelector('#screen-breath').style.display !== 'none'){ text.innerText = "ä¿æŒ..."; ball.innerText = "åœ"; } }, 3200);
            setTimeout(() => { if(document.querySelector('#screen-breath').style.display !== 'none'){ text.innerText = "æ…¢æ…¢åæ°£..."; ball.innerText = "å"; } }, 4000);
            setTimeout(() => { if(document.querySelector('#screen-breath').style.display !== 'none'){ text.innerText = "æ…¢æ…¢å¸æ°£..."; ball.innerText = "å¸"; } }, 8000);
        };
        run(); breathInterval = setInterval(run, 8000);
    }
    function stopBreath() { document.getElementById('breath-ball').classList.remove('breathing'); if(breathInterval) clearInterval(breathInterval); }

    // å„²å­˜
    function saveMoodToCloud() {
        let text = document.getElementById('mood-input').value;
        if(text.trim() === "" && !hasDrawn) text = "(æ²’æœ‰æ–‡å­—è¨˜éŒ„)";
        const btn = document.getElementById('save-btn'); const loader = document.getElementById('save-loader');
        loader.style.display = 'block'; btn.disabled = true;
        const data = { action: 'save', mood: currentMood, text: text, image: null };
        if (hasDrawn && canvas) data.image = canvas.toDataURL('image/jpeg', 0.5);
        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
        .then(() => { loader.style.display = 'none'; btn.disabled = false; document.getElementById('mood-input').value = ""; if(canvas) clearCanvas(); navigate('#screen-action'); cachedData = []; }) // æ¸…ç©ºå¿«å–ä»¥å¼·åˆ¶é‡æ•´
        .catch(err => { alert("å„²å­˜å¤±æ•—"); btn.disabled = false; });
    }

    // è®€å–æ­·å²
    function loadHistory() {
        navigate('#screen-history');
        const container = document.getElementById('history-container'); const loader = document.getElementById('history-loader');
        container.innerHTML = ""; loader.style.display = 'block';
        fetch(GOOGLE_SCRIPT_URL).then(res => res.json()).then(data => {
            loader.style.display = 'none'; cachedData = data; // æ›´æ–°å¿«å–
            data.reverse();
            if (data.length === 0) { container.innerHTML = "<p>ç„¡ç´€éŒ„</p>"; return; }
            data.forEach(row => {
                let timeStr = new Date(row[0]).toLocaleString('zh-TW', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' });
                let cardClass = row[1] === "ç´…ç‡ˆ" ? "card-red" : row[1] === "é»ƒç‡ˆ" ? "card-yellow" : "card-green";
                const card = document.createElement('div'); card.className = `history-card ${cardClass}`;
                card.innerHTML = `<div class="history-time">${timeStr}</div><div class="history-mood">${row[1]}</div><div class="history-text">${row[2]}</div><button class="delete-btn" onclick="deleteHistory('${row[0]}', this)">åˆªé™¤</button>`;
                container.appendChild(card);
            });
        }).catch(err => { loader.style.display = 'none'; container.innerHTML = "<p>è®€å–å¤±æ•—</p>"; });
    }

    function deleteHistory(timeStr, btn) {
        if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return; btn.innerText = "...";
        const data = { action: 'delete', time: timeStr };
        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
        .then(() => { const card = btn.parentElement; card.style.opacity = '0'; setTimeout(() => card.remove(), 300); cachedData = []; });
    }

    // === å¿ƒæƒ…æœˆæ›†åŠŸèƒ½ (New!) ===
    function loadCalendar() {
        navigate('#screen-calendar');
        renderCalendar();
        
        // åªæœ‰ç•¶æ²’æœ‰è³‡æ–™æ™‚æ‰å»æŠ“
        if(cachedData.length === 0) {
            document.getElementById('cal-loader').style.display = 'block';
            fetch(GOOGLE_SCRIPT_URL).then(res => res.json()).then(data => {
                document.getElementById('cal-loader').style.display = 'none';
                cachedData = data;
                renderCalendar(); // è³‡æ–™å›ä¾†å¾Œé‡æ–°æ¸²æŸ“
            });
        }
    }

    function changeMonth(delta) {
        currentCalDate.setMonth(currentCalDate.getMonth() + delta);
        renderCalendar();
    }

    function renderCalendar() {
        const year = currentCalDate.getFullYear();
        const month = currentCalDate.getMonth();
        
        // æ›´æ–°æ¨™é¡Œ
        document.getElementById('cal-month-title').innerText = `${year}å¹´ ${month + 1}æœˆ`;
        
        // è¨ˆç®—è©²æœˆå¤©æ•¸
        const firstDay = new Date(year, month, 1).getDay(); // é€™å€‹æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå¹¾
        const daysInMonth = new Date(year, month + 1, 0).getDate(); // é€™å€‹æœˆæœ‰å¹¾å¤©
        
        const calDays = document.getElementById('cal-days');
        calDays.innerHTML = "";
        
        // æ•´ç†æ•¸æ“šï¼šæŠŠè³‡æ–™æŒ‰æ—¥æœŸåˆ†é¡
        // mapping: { "2024-1-5": ["ç´…ç‡ˆ", "ç¶ ç‡ˆ"] }
        let moodMap = {};
        let stats = { "ç´…ç‡ˆ": 0, "é»ƒç‡ˆ": 0, "ç¶ ç‡ˆ": 0 };

        cachedData.forEach(row => {
            let d = new Date(row[0]);
            // åªè™•ç†ç•¶å‰æœˆä»½çš„è³‡æ–™
            if(d.getFullYear() === year && d.getMonth() === month) {
                let dateKey = d.getDate(); // 1, 2, 3...
                if(!moodMap[dateKey]) moodMap[dateKey] = [];
                moodMap[dateKey].push(row[1]);
                
                // çµ±è¨ˆ
                if(stats[row[1]] !== undefined) stats[row[1]]++;
            }
        });

        // æ›´æ–°ä¸‹æ–¹çµ±è¨ˆæ•¸å­—
        document.getElementById('stat-red').innerText = stats["ç´…ç‡ˆ"];
        document.getElementById('stat-yellow').innerText = stats["é»ƒç‡ˆ"];
        document.getElementById('stat-green').innerText = stats["ç¶ ç‡ˆ"];

        // å¡«è£œå‰é¢çš„ç©ºç™½
        for(let i=0; i<firstDay; i++) {
            const emptyCell = document.createElement('div');
            calDays.appendChild(emptyCell);
        }

        // ç”¢ç”Ÿæ—¥æœŸæ ¼å­
        for(let i=1; i<=daysInMonth; i++) {
            const cell = document.createElement('div');
            cell.className = "cal-day";
            cell.innerText = i;
            
            // è©²æ—¥æœŸæœ‰å¿ƒæƒ…ç´€éŒ„å—ï¼Ÿ
            if(moodMap[i]) {
                const dotsContainer = document.createElement('div');
                dotsContainer.className = "cal-dots";
                
                // é¡¯ç¤ºå°åœ“é» (æœ€å¤šé¡¯ç¤º3å€‹ï¼Œé¿å…å¤ªæ“ )
                moodMap[i].forEach(mood => {
                    const dot = document.createElement('div');
                    dot.className = "dot " + (mood==="ç´…ç‡ˆ"?"dot-r": mood==="é»ƒç‡ˆ"?"dot-y":"dot-g");
                    dotsContainer.appendChild(dot);
                });
                cell.appendChild(dotsContainer);
            }
            calDays.appendChild(cell);
        }
    }
</script>

</body>
</html>
